<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mister-hope.github.io/cpu/simple_cpu.html"><meta property="og:site_name" content="Jielahou's Blog"><meta property="og:title" content="简单流水线CPU设计"><meta property="og:description" content="本文是对《CPU设计实战》（汪文祥 邢金璋 著）一书第四章的简单总结、概括。 设计一个简单的单周期CPU CPU设计的一般方法：数据通路+控制逻辑 准备工作 如何划分模块 某层次设计细节很多，很难画出来，把他干成一个框，作为一个模块 模块的接口不应该有太多 可以被多次使用的，比如译码器、多路选择器、寄存器堆、RAM、FIFO（First In First Out） 两个模块间数据总体应该呈单向流动，至多一去一回。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-01-13T12:54:09.000Z"><meta property="article:modified_time" content="2023-01-13T12:54:09.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"简单流水线CPU设计","image":[""],"dateModified":"2023-01-13T12:54:09.000Z","author":[]}</script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js?id=KDeTDcfevxjOrgMS&ck=KDeTDcfevxjOrgMS"></script><title>简单流水线CPU设计 | Jielahou's Blog</title><meta name="description" content="本文是对《CPU设计实战》（汪文祥 邢金璋 著）一书第四章的简单总结、概括。 设计一个简单的单周期CPU CPU设计的一般方法：数据通路+控制逻辑 准备工作 如何划分模块 某层次设计细节很多，很难画出来，把他干成一个框，作为一个模块 模块的接口不应该有太多 可以被多次使用的，比如译码器、多路选择器、寄存器堆、RAM、FIFO（First In First Out） 两个模块间数据总体应该呈单向流动，至多一去一回。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-122b92f0.css" as="style"><link rel="stylesheet" href="/assets/style-122b92f0.css">
    <link rel="modulepreload" href="/assets/app-65907bd0.js"><link rel="modulepreload" href="/assets/framework-01af7397.js"><link rel="modulepreload" href="/assets/simple_cpu.html-cdffa542.js"><link rel="modulepreload" href="/assets/simple_cpu.html-74f1c358.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><!----><!----><span class="site-name">Jielahou&#39;s Blog</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/intro.html" class="nav-link" aria-label="关于"><span class="font-icon icon iconfont icon-info" style=""></span>关于<!----></a></div><div class="nav-item hide-in-mobile"><a href="/link.html" class="nav-link" aria-label="友链"><span class="font-icon icon iconfont icon-link" style=""></span>友链<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/jielahou/jielahou-blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->简单流水线CPU设计</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://jielahou.com" target="_blank" rel="noopener noreferrer">jielahou</a></span><span property="author" content="jielahou"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-01-10T10:02:39.000Z"></span><!----><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 12 分钟</span><meta property="timeRequired" content="PT12M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#准备工作" class="router-link-active router-link-exact-active toc-link level2">准备工作</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#如何划分模块" class="router-link-active router-link-exact-active toc-link level3">如何划分模块</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#pc" class="router-link-active router-link-exact-active toc-link level3">PC</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#虚实地址转换" class="router-link-active router-link-exact-active toc-link level3">虚实地址转换</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#指令ram" class="router-link-active router-link-exact-active toc-link level3">指令RAM</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#数据通路设计" class="router-link-active router-link-exact-active toc-link level2">数据通路设计</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#addu指令" class="router-link-active router-link-exact-active toc-link level3">ADDU指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#addiu指令" class="router-link-active router-link-exact-active toc-link level3">ADDIU指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#subu指令" class="router-link-active router-link-exact-active toc-link level3">SUBU指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#lw指令" class="router-link-active router-link-exact-active toc-link level3">LW指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#sw指令" class="router-link-active router-link-exact-active toc-link level3">SW指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#beq和bne指令" class="router-link-active router-link-exact-active toc-link level3">BEQ和BNE指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#jal指令" class="router-link-active router-link-exact-active toc-link level3">JAL指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#jr指令" class="router-link-active router-link-exact-active toc-link level3">JR指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#slt和sltu指令" class="router-link-active router-link-exact-active toc-link level3">SLT和SLTU指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#sll、srl和sra指令" class="router-link-active router-link-exact-active toc-link level3">SLL、SRL和SRA指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#lui、and、or、xor和nor指令" class="router-link-active router-link-exact-active toc-link level3">LUI、AND、OR、XOR和NOR指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#alu" class="router-link-active router-link-exact-active toc-link level3">ALU</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#控制信号" class="router-link-active router-link-exact-active toc-link level2">控制信号</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#alu的控制信号" class="router-link-active router-link-exact-active toc-link level3">ALU的控制信号</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cpu/simple_cpu.html#选择器的控制信号" class="router-link-active router-link-exact-active toc-link level3">选择器的控制信号</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><blockquote><p>本文是对《CPU设计实战》（汪文祥 邢金璋 著）一书第四章的简单总结、概括。</p></blockquote><h1 id="设计一个简单的单周期cpu" tabindex="-1"><a class="header-anchor" href="#设计一个简单的单周期cpu" aria-hidden="true">#</a> 设计一个简单的单周期CPU</h1><blockquote><p>CPU设计的一般方法：数据通路+控制逻辑</p></blockquote><h2 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作" aria-hidden="true">#</a> 准备工作</h2><h3 id="如何划分模块" tabindex="-1"><a class="header-anchor" href="#如何划分模块" aria-hidden="true">#</a> 如何划分模块</h3><ul><li>某层次设计细节很多，很难画出来，把他干成一个框，作为一个模块</li><li>模块的<strong>接口不应该有太多</strong></li><li>可以被多次使用的，比如译码器、多路选择器、寄存器堆、RAM、FIFO（First In First Out）</li><li>两个模块间数据总体应该呈<strong>单向流动</strong>，至多一去一回。</li></ul><h3 id="pc" tabindex="-1"><a class="header-anchor" href="#pc" aria-hidden="true">#</a> PC</h3><p>PC的输入有两个：一个是复位值<code>0xBFC00000</code>，一个是复位撤销后每执行一条指令，当前<code>PC+4</code>的结果。</p><h3 id="虚实地址转换" tabindex="-1"><a class="header-anchor" href="#虚实地址转换" aria-hidden="true">#</a> 虚实地址转换</h3><p>在实现TLB和MMU之前，我们采用<strong>固定映射</strong>的地址映射机制。</p><p><code>kseg0</code>（<code>0x80000000</code><sub>`0x9FFFFFFF`）映射到物理地址最低512M（`0x00000000`</sub><code>0x1FFFFFFF</code>）；</p><p><code>kseg1</code>（<code>0xA0000000</code><sub>`0xBFFFFFFF`）也映射到物理地址最低512M（`0x00000000`</sub><code>0x1FFFFFFF</code>）；</p><p>其余三个段（<code>kuseg</code>、<code>kseg2</code>、<code>kseg3</code>）虚地址等于物理地址。</p><h3 id="指令ram" tabindex="-1"><a class="header-anchor" href="#指令ram" aria-hidden="true">#</a> 指令RAM</h3><p>由于欲实现的CPU指令宽度为32比特，所以RAM的宽度至少为32比特。但RAM还是按照字节寻址的，所以我们要将取指地址除4后取整的结果作为RAM的地址输入。</p><h2 id="数据通路设计" tabindex="-1"><a class="header-anchor" href="#数据通路设计" aria-hidden="true">#</a> 数据通路设计</h2><h3 id="addu指令" tabindex="-1"><a class="header-anchor" href="#addu指令" aria-hidden="true">#</a> ADDU指令</h3><p>通用寄存器堆的读端口1和读端口2分别和<code>rs</code>、<code>rt</code>相连；</p><p>要实现加法，需要一个加法器。加法器两个输入<code>src1</code>、<code>src2</code>分别来自通用寄存器堆的<code>rdata1</code>、<code>rdata2</code>，输出<code>result</code>连接通用寄存器堆的<code>wdata</code>。</p><h3 id="addiu指令" tabindex="-1"><a class="header-anchor" href="#addiu指令" aria-hidden="true">#</a> ADDIU指令</h3><blockquote><p>ADDIU和ADDU指令很像，如何兼顾差异性，又能最大限度复用呢？</p></blockquote><p>从差异性入手，ADDIU和ADDU指令区别于ADDIU第二个操作数来自于指令的<code>15..0</code>位符号拓展至32位后形成的数据。所以在加法器<code>src2</code>输入端口前面加一个<strong>二选一</strong>部件。<code>in0</code>来自于通用寄存器堆的<code>rdata2</code>，<code>in1</code>来自指令的<code>15..0</code>位符号拓展至32位后形成的数据。控制信号的生成（包括接下来若干条指令的控制信号）统一放到最后说。</p><p>另一个区别，ADDU写入第<code>rd</code>号寄存器，ADDIU写入第<code>rt</code>号寄存器。在通用寄存器堆前面也加一个二选一部件，<code>in0</code>来自<code>rd</code>，<code>in1</code>来自<code>rt</code>。</p><blockquote><p>剧透一下，这里的二选一部件，我们实现为**“独热码”**，即有多少个输入源，就安排多少个选择信号，一个信号控制一个源，要输出哪一路数据，直接将这个信号置为1即可。</p></blockquote><h3 id="subu指令" tabindex="-1"><a class="header-anchor" href="#subu指令" aria-hidden="true">#</a> SUBU指令</h3><p>复用加法器来实现减法，处理方法如下：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">[</mo><mi>A</mi><msub><mo stretchy="false">]</mo><mrow><mtext>原码</mtext><mn>31..0</mn></mrow></msub><mo>−</mo><mo stretchy="false">[</mo><mi>B</mi><msub><mo stretchy="false">]</mo><mrow><mtext>原码</mtext><mn>31..0</mn></mrow></msub><mo>=</mo><mo stretchy="false">[</mo><mi>A</mi><msub><mo stretchy="false">]</mo><mrow><mtext>原码</mtext><mn>31..0</mn></mrow></msub><mo>+</mo><mo stretchy="false">(</mo><mstyle mathcolor="#cc0000"><mtext>\textasciitilde</mtext></mstyle><mo stretchy="false">[</mo><mi>B</mi><msub><mo stretchy="false">]</mo><mrow><mtext>原码</mtext><mn>31..0</mn></mrow></msub><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex"> [A]_{原码31..0}-[B]_{原码31..0}=[A]_{原码31..0}+(\textasciitilde[B]_{原码31..0})+1 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">A</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">原码</span><span class="mord mtight">31..0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">原码</span><span class="mord mtight">31..0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">A</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">原码</span><span class="mord mtight">31..0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\textasciitilde</span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">原码</span><span class="mord mtight">31..0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span></p><p>其中<code>~</code>是按位取反，上式中即为对<code>[B]原码</code>的32位取反。</p><p>于是需要在加法器的<code>src2</code>前面再加一个二选一部件：处理加法时不取反，直接进来；处理减法时先取反，再进来。</p><p>后面还有一个<code>+</code>，可以通过<strong>操作加法器进位输入</strong>实现。处理加法进位输入是0，操作减法进位输入是1。</p><h3 id="lw指令" tabindex="-1"><a class="header-anchor" href="#lw指令" aria-hidden="true">#</a> LW指令</h3><h4 id="访存地址生成" tabindex="-1"><a class="header-anchor" href="#访存地址生成" aria-hidden="true">#</a> 访存地址生成</h4><p>要求是将<code>rs</code>和指令中的立即数相加，和<code>ADDIU</code>一致。</p><h4 id="从数据ram中读数据" tabindex="-1"><a class="header-anchor" href="#从数据ram中读数据" aria-hidden="true">#</a> 从数据RAM中读数据</h4><p>根据指令系统规范文档中对<code>LW</code>指令的描述，<code>LW</code>一次性要读4个字节写入第<code>rt</code>号寄存器。所以数据RAM宽度也应该是32位，因此<code>LW</code>指令的访存地址应该是4的倍数。</p><h4 id="寄存器写回结果选择" tabindex="-1"><a class="header-anchor" href="#寄存器写回结果选择" aria-hidden="true">#</a> 寄存器写回结果选择</h4><p>之前我们只有<code>ADDU</code>、<code>ADDIU</code>两条指令写寄存器，那俩都是将加法器的结果接到通用寄存器堆的<code>wdata</code>上，写入寄存器。现在又多一个<code>LW</code>，那只能在寄存器堆<code>wdata</code>前面再加一个二选一部件。</p><h3 id="sw指令" tabindex="-1"><a class="header-anchor" href="#sw指令" aria-hidden="true">#</a> SW指令</h3><p><code>SW</code>指令将<code>rt</code>寄存器的内容写入数据RAM，因此我们将通用寄存器堆的<code>rdata2</code>和数据RAM的<code>wdata</code>相连，将数据RAM的写使能作为控制信号。</p><h3 id="beq和bne指令" tabindex="-1"><a class="header-anchor" href="#beq和bne指令" aria-hidden="true">#</a> BEQ和BNE指令</h3><h4 id="判断分支条件" tabindex="-1"><a class="header-anchor" href="#判断分支条件" aria-hidden="true">#</a> 判断分支条件</h4><p>要比较两个寄存器中的数字，一种方法是复用加法器，做减法，看结果；另一种方法是设置<strong>独立的分支判断逻辑</strong>。</p><h4 id="计算跳转目标" tabindex="-1"><a class="header-anchor" href="#计算跳转目标" aria-hidden="true">#</a> 计算跳转目标</h4><p>MIPS中有“延迟槽”的概念，由于判断分支条件会浪费一些时间，于是便可以把<strong>不管是不是跳转一定要执行的指令</strong>放在<strong>条件分支指令</strong>（注意是条件分支）的后面，在判断分支条件时并行执行，提高效率。</p><p>这意味着如果有一个PC为A的指令，使用分支跳转指令如果成功跳到B的话，其执行轨迹实际上是A、A+4、B。所以<strong>执行分支指令后面的延迟槽指令时</strong>才是<strong>真正调整PC的时机</strong>。</p><p>故<code>BEQ</code>和<code>BNE</code>计算跳转目标时是<strong>基于延迟槽指令的PC</strong>再加上(<code>offset</code>左移两位的结果)得到的。</p><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>在执行延迟槽指令的时候，<strong>当前PC值</strong>自然便是<strong>延迟槽指令的PC</strong>，加上上面说的计算规则，所以我们<strong>在执行延迟槽指令时</strong>，进行计算PC的工作。</p><blockquote><p>所以我们还要把<code>offset</code>用一个触发器给存起来</p></blockquote></div><h4 id="pc更新" tabindex="-1"><a class="header-anchor" href="#pc更新" aria-hidden="true">#</a> PC更新</h4><p>由于是在下一条延迟槽指令进行PC更新，~~所以我们需要将加法器（毕竟复用了<code>ADDIU</code>的数据通路么）的输出放入一个触发器中。~~理解错了！！不是在执行<code>BEQ</code>、<code>BNE</code>指令的时候算好，而是<strong>在执行延迟槽指令的时候</strong>基于存起来的<code>offset</code><strong>算</strong>。</p><p>既然引入了分支跳转指令，<code>nextPC</code>的来源不只是当前指令PC+4了。我们要给<code>nextPC</code>加一个二选一部件，<code>in0</code>来自PC+4，另一个输入<code>in1</code>来自执行延迟槽指令时的计算。</p><p>什么时候选择触发器中的数据呢？条件有二：一是当前<strong>正在执行延迟槽中的指令</strong>，二是<code>BEQ</code>、<code>BNE</code><strong>要求跳转</strong>。对于第二点，我们需要<strong>在执行<code>BEQ</code>、<code>BNE</code>指令的时候就用一个触发器记录下来是否跳转</strong>，以便在执行延迟槽指令时做出正确选择。</p><h3 id="jal指令" tabindex="-1"><a class="header-anchor" href="#jal指令" aria-hidden="true">#</a> JAL指令</h3><p><code>JAL</code>=<code>Jump And Link</code>，其中<code>Link</code>要求将该跳转的延迟槽指令PC+4的结果写入第31号寄存器中。这么做可以解决函数调用中<code>call</code>和<code>return</code>的问题：通常，在某处<code>call</code>函数时，函数执行完成后要<code>return</code>到<code>call</code>的地方。那么就可以在<code>call</code>函数时调用<code>JAL</code>指令，将返回处PC写入寄存器，在<code>return</code>时从这个寄存器中取欲返回的地址即可。</p><h4 id="计算跳转目标-1" tabindex="-1"><a class="header-anchor" href="#计算跳转目标-1" aria-hidden="true">#</a> 计算跳转目标</h4><p>同<code>BEQ</code>指令那般，我们同样需要计算跳转目标。<code>JAL</code>指令计算跳转目标的方式是拼接，跳转目标由该分支指令对应的延迟槽指令的PC的最高4位与指令中的立即数<code>instr_index</code>左移2位后的值拼接得到。</p><h4 id="写寄存器" tabindex="-1"><a class="header-anchor" href="#写寄存器" aria-hidden="true">#</a> 写寄存器</h4><p>由于还要完成上文介绍的<code>Link</code>流程，所以<code>JAL</code>指令除了要更改PC，还要将返回地址写寄存器。返回地址理论上是延迟槽指令的下一条，即<code>延迟槽指令的PC+4</code>，但由于<strong>返回地址写寄存器的过程</strong>是在<strong>执行<code>JAL</code>指令</strong>而不是执行延迟槽指令时完成的，所以写寄存器的值便是<code>JAL指令的PC+8</code>。</p><p>这个值如何计算呢？可以借助已有的加法器进行计算。这就要求在加法器的<code>src1</code>前面加一个二选一，<code>in0</code>来自寄存器堆的<code>rs</code>，<code>in1</code>来自当前的PC；将原本<code>src2</code>前面的二选一改成三选一，加一个<code>in2</code>，<code>in2</code>为常值8。</p><p>由于<code>JAL</code>隐含写第31号寄存器，所以寄存器堆的<code>waddr</code>又要增加一个新的来源，变成三选一（书上写得三选一，个人认为到目前为止还是二选一，存疑。前面介绍的<code>ADDU</code>、<code>ADDIU</code>、<code>SUBU</code>、<code>LW</code>都是采用了指令中的<code>rt</code>字段作为<code>waddr</code>）。</p><h4 id="更新pc" tabindex="-1"><a class="header-anchor" href="#更新pc" aria-hidden="true">#</a> 更新PC</h4><p>更新PC是在执行延迟槽指令时进行，和前面的<code>BEQ</code>、<code>BNE</code>想法类似。基本思路是在执行<code>JAL</code>指令时将指令中的立即数存起来，执行延迟槽指令的时候再用来计算。由于计算方法和<code>BEQ</code>、<code>BNE</code>不同，所以原本<code>nextPC</code>前面接的二选一要变成三选一了。</p><h3 id="jr指令" tabindex="-1"><a class="header-anchor" href="#jr指令" aria-hidden="true">#</a> JR指令</h3><p><code>JR</code>指令是无条件跳转指令，跳转目标为寄存器<code>rs</code>中的值。</p><p>根据手册，其仍然是在延迟槽指令更改PC，所以<code>nextPC</code>要变成四选一了，新增<code>in3</code>信号直接和寄存器堆的读端口<code>rdata1</code>相连。</p><h3 id="slt和sltu指令" tabindex="-1"><a class="header-anchor" href="#slt和sltu指令" aria-hidden="true">#</a> SLT和SLTU指令</h3><p><code>SLT</code>和<code>SLTU</code>指令比较<code>rs</code>和<code>rt</code>寄存器中所存数据的大小，如果<code>rs &lt; rt</code>，则把<code>rd</code>寄存器置<code>1</code>。</p><p>比大小，可以<strong>复用加法器</strong>做减法，节省资源。</p><p>对于有符号数，先比较符号，如果一正一负，不用再比了；如果符号一致，再做减法，结果最高位如果是1，说明被减数小。</p><p>对于无符号数，直接通过减来确定。如果采取上面看最高位的思路，走不通。因为无符号数没有符号位，32位全部用来表示数字了。方案一是将32位加法器变成33位，方案二是利用加法器的<code>Cout</code>，如果是1，说明被减数小。两者原理一致。</p><h3 id="sll、srl和sra指令" tabindex="-1"><a class="header-anchor" href="#sll、srl和sra指令" aria-hidden="true">#</a> SLL、SRL和SRA指令</h3><h4 id="移位器的输入、输出" tabindex="-1"><a class="header-anchor" href="#移位器的输入、输出" aria-hidden="true">#</a> 移位器的输入、输出</h4><p>输入：被移位的数值<code>src</code>（由于<code>src</code>是指令中指定的<code>rt</code>号寄存器的值，故来自寄存器堆<code>rdata2</code>端口）、5位的位移量<code>sa</code>（指令中的<code>sa</code>字段）、控制移位类型的<code>op</code></p><p>输出：32位移位结果<code>res</code></p><h4 id="移位器的内部实现" tabindex="-1"><a class="header-anchor" href="#移位器的内部实现" aria-hidden="true">#</a> 移位器的内部实现</h4><p>省流：被移位数据<strong>逆序排列</strong>，使得左移用右移实现</p><div class="hint-container info"><p class="hint-container-title">书上解释为啥要共用数据通路</p><p>移位逻辑本质上是译码逻辑和多路选择逻辑，32位数的移位就是对32个32位数进行32选1，这套逻辑的面积大、延迟长。</p></div><div class="language-verilog line-numbers-mode" data-ext="verilog"><pre class="language-verilog"><code><span class="token comment">//书上是这么写的shft_src，我感觉好像反了</span>
<span class="token keyword">assign</span> shft_src <span class="token operator">=</span> op_srl <span class="token operator">?</span> <span class="token operator">{</span>src<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            src<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            src<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            src<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            src<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            src<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            src<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            src<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">}</span> <span class="token punctuation">:</span> src<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> shft_res <span class="token operator">=</span> shft_src<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> shft_amt<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//不写[]会怎么样呢？</span>
<span class="token keyword">assign</span> sra_mask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">32&#39;hffff_ffff</span> <span class="token operator">&gt;&gt;</span> shft_amt<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//下面就是各个指令的结果了</span>
<span class="token keyword">assign</span> srl_res <span class="token operator">=</span> shft_res<span class="token punctuation">;</span>
<span class="token keyword">assign</span> sra_res <span class="token operator">=</span> <span class="token punctuation">(</span>sra_mask <span class="token operator">&amp;</span> <span class="token operator">{</span><span class="token number">32</span><span class="token operator">{</span>shft_src<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">}}</span><span class="token punctuation">)</span> <span class="token operator">|</span> shft_res<span class="token punctuation">;</span>
<span class="token keyword">assign</span> sll_res <span class="token operator">=</span> <span class="token operator">{</span>
    shft_src<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    shft_src<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    shft_src<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    shft_src<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    shft_src<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    shft_src<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    shft_src<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    shft_src<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shft_src<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token operator">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="lui、and、or、xor和nor指令" tabindex="-1"><a class="header-anchor" href="#lui、and、or、xor和nor指令" aria-hidden="true">#</a> LUI、AND、OR、XOR和NOR指令</h3><p>对于<code>AND</code>、<code>OR</code>、<code>XOR</code>和<code>NOR</code>指令，都是<code>rs</code>与<code>rt</code>寄存器做运算后，将结果写入<code>rt</code>寄存器，可以复用现有的数据通路。</p><p>对于<code>LUI</code>，将立即数写入<code>rt</code>寄存器中，也可以复用已有通路。（复用<code>LW</code>的）</p><h3 id="alu" tabindex="-1"><a class="header-anchor" href="#alu" aria-hidden="true">#</a> ALU</h3><p>我们可以将<code>ADDU</code>、<code>ADDIU</code>、<code>SUBU</code>、<code>SLT</code>、<code>SLTU</code>、<code>SLL</code>、<code>SRL</code>、<code>SRA</code>、<code>LUI</code>、<code>AND</code>、<code>OR</code>、<code>XOR</code>和<code>NOR</code>指令处理运算的逻辑<strong>集中到一个模块中</strong>。</p><p>输入：32位的<code>alu_src1</code>、<code>alu_src2</code>，控制信号<code>alu_op</code>（采用独热码）</p><p>输出：32位的<code>alu_res</code>、32位的<code>mem_addr</code>（结果直接来自加法器，优化访存指令的时序）</p><h2 id="控制信号" tabindex="-1"><a class="header-anchor" href="#控制信号" aria-hidden="true">#</a> 控制信号</h2><blockquote><p>为了节省篇幅，仅介绍大致思路，更详细的内容请看书。</p></blockquote><h3 id="alu的控制信号" tabindex="-1"><a class="header-anchor" href="#alu的控制信号" aria-hidden="true">#</a> ALU的控制信号</h3><p>ALU的控制信号指的是<code>alu_op</code>，设计成独热码。</p><p>有些指令虽然不是ALU运算指令，但是却会用到譬如加法器、移位器等部件。这就意味着不同的指令，可能会共用一个<code>alu_op</code>。</p><h3 id="选择器的控制信号" tabindex="-1"><a class="header-anchor" href="#选择器的控制信号" aria-hidden="true">#</a> 选择器的控制信号</h3><p>上文中我们引入了一些“X选一”选择器，这一小节主要关注如何处理这些“X选一”选择器的控制信号。</p><p>这些<strong>控制信号到底取什么</strong>，<strong>取决于当前指令是什么</strong>。所以我们可以先对指令进行“分析”，获知当前是什么指令，<code>sa</code>域是多少，<code>func</code>域是多少，然后便知道这是条什么指令了：</p><div class="language-verilog line-numbers-mode" data-ext="verilog"><pre class="language-verilog"><code><span class="token keyword">assign</span> op <span class="token operator">=</span> inst<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> sa <span class="token operator">=</span> inst<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> func <span class="token operator">=</span> inst<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

decoder_6_64 <span class="token function">u_dec0</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span>op_d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
decoder_5_32 <span class="token function">u_dec0</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span>sa_d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
decoder_6_64 <span class="token function">u_dec0</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span>func_d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">assign</span> inst_addu <span class="token operator">=</span> op_d<span class="token punctuation">[</span><span class="token number">6&#39;h00</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> func_d<span class="token punctuation">[</span><span class="token number">6&#39;h21</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> sa_d<span class="token punctuation">[</span><span class="token number">5&#39;h00</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//是不是ADDU指令？</span>
<span class="token comment">//...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>于是，对于只有1位的控制信号，可以这么写：</p><div class="language-verilog line-numbers-mode" data-ext="verilog"><pre class="language-verilog"><code><span class="token keyword">assign</span> data_ram_en <span class="token operator">=</span> inst_lw <span class="token operator">|</span> inst_sw<span class="token punctuation">;</span>
<span class="token comment">//只有是inst_lw、inst_sw的时候，ram_en是1</span>
<span class="token comment">//很清晰吧！</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><s>书上没有给多位控制信号的例子，我想或许可以用移位写？</s></p><p>如果有多位控制信号、且采用独热码，可以将每一位看成是1位的控制信号，针对每一位进行操作：</p><div class="language-verilog line-numbers-mode" data-ext="verilog"><pre class="language-verilog"><code><span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_addu <span class="token operator">|</span> inst_addiu <span class="token operator">|</span> inst_lw <span class="token operator">|</span> inst_sw <span class="token operator">|</span> inst_jal<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_subu<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_slt<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_sltu<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_and<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_nor<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_or<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_xor<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_sll<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span> <span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_srl<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_sra<span class="token punctuation">;</span>
<span class="token keyword">assign</span> alu_op<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> inst_lui<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/jielahou/jielahou-blog/edit/main/docs/cpu/simple_cpu.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: jielahou@gmail.com">jielahou</span><!--]--><!--]--></div></footer><!----><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright © 2024 jielahou</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-65907bd0.js" defer></script>
  </body>
</html>
